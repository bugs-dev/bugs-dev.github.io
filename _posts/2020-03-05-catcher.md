---
layout: post
title:  "Catcher - 캐시 성능향상을 위한 시도"
description: 캐시 성능향상을 위해 대기시간, 다수요청처리 등의 문제점 개선
date:   2020-03-05 00:00:00
categories: java
authore: ybkim
---


# 캐시 성능향상을 위한 시도

<br>

## 목차

1. 기존의 캐시사용 방식
2. Catcher 소개
3. Catcher 사용법
4. 끝

<br>

### 기존의 캐시사용 방식

일반적인 캐시의 사용법은,  
자주 사용되거나 긴 처리시간을 요구하는 코드부분을 정하고, 고유한 키와 만료시간을 부여하여, 
해당코드의 실행결과를 캐시에 저장하고 만료시간 안에는 코드의 실행대신 캐시를 사용하는 것으로 처리성능을 향상시키는 것.

여기서 문제점은  

* 캐시가 정기적으로 만료되어 갱신되는 시간에는 캐시생성 시간만큼의 대기시간이 필요
* 캐시만료 순간에 집중되는 다수의 요청으로 인해서 동일한 키와 동일한 결과를 반환하는 다수의 캐시생성 시도도 역시 발생   
  
위의 원인으로 만료시간마다 처리 리소스가 증가하게 됨.

<br>

### Catcher 소개

Catcher는 코드와 캐시요청 사이에서 캐시의 갱신과 다수요청에 대한 제어를 처리.
<span class="post-img">
![Position of Catcher](/assets/images/post/catcher/Position of Catcher.JPG)
<span class="caption">Catcher</span>
</span>

기존 캐시에는 오리지널 데이터를 저장하는것 대신에  
여러가지 속성을 제어할 수 있는 확장된 데이터 형태로 저장
<span class="post-img">
![Extended Cache Data](/assets/images/post/catcher/Extended Cache Data.JPG)
<span class="caption">Extended Cache Data</span>
</span>

Catcher는 기존 캐시사용 방식의 문제점에 대응하기 위해서 아래 방법을 적용

* 비동기 갱신 : 반복되는 캐시만료시간의 캐시생성대기시간을 제거
* 캐시상태 관리 : 동시에 다수의 요청에 의해 발생하는 불필요한 캐시생성시도 개선

<br>

Single Request 비교

<span class="post-img">
![Single Request on Sync](/assets/images/post/catcher/Single Request on Sync.JPG)
<span class="caption">Single Request - sync</span>
</span>

***

<span class="post-img">
![Single Request with Catcher](/assets/images/post/catcher/Single Request with Catcher.JPG)
<span class="caption">Single Request - Catcher</span>
</span>

<br>

Multi Request 비교

<span class="post-img">
![Multi Request on Sync](/assets/images/post/catcher/Multi Request on Sync.JPG){: style="border:solid 1px #cccccc"}
<span class="caption">Multi Request - sync</span>
</span>

***

<span class="post-img">
![Multi Request with Catcher](/assets/images/post/catcher/Multi Request with Catcher.JPG)
<span class="caption">Multi Request - Catcher</span>
</span>  

<br>


### Catcher 사용법

```java
/**
Catcher catcher = new Catcher(Function cacheResourceSetter, Function cacheResourceGetter)
**/
Catcher catcher = new Catcher(
      (cData)->{
          //set data to origin cache
          //cData is CacheData
          return true
      },
      (cacheKey)->{
          //get data from origin cache
          //cData is CacheData
          return cData
      }
  );


/**
catcher.getSet(
    String cacheKey, 
    Supplier lambda for create cache data, 
    int refresh sec, 
    int expire sec, 
    boolean asyncRefresh, 
    boolean startNotNull
)
**/
catcher.getSet('testKey', ()->{
    //long delay process (access database, call api, ..etc)
}, 5, 100, true, true);
```


```java
static Catcher catcher;
static public int cacheCount = 0;

public static void main(String[] args) throws Exception {

  System.out.println("Catcher Test");

  Map<String, Object> cacheResource = new HashMap<>();

  catcher = new Catcher(
    (cData)->{
        CcData ccData = (CcData)cData;
        try{
            cacheResource.put(ccData.key, ccData);
            return true;
        }
        catch(Exception e){
            e.printStackTrace();
            return false;
        }
    },
    (cacheKey)->{
        return cacheResource.get(cacheKey);
    }
  );

  int count = 0;
  while(count < 3){
    ExThread request = new ExThread((id)->{
      while(true){
        try{
            Thread.sleep((int)(Math.random()*1000) + 2000);
            String value = getSetCacheData("key1", id.toString());
            System.out.println(id + " - get cache : " + value);
        }
        catch (Exception e){
            e.printStackTrace();
        }

      }
    }, "thread-" + count);
    request.start();
    count++;
  }

}


static String getSetCacheData(String key, String id){
  return catcher.getSet(key, ()->{
    try{
      int delay = 3000;
      Thread.sleep(delay);
      System.out.println("cache created / id : " + id + " / delay :  " + delay + "");
      SimpleDateFormat simpleDateFormat = new SimpleDateFormat("HH:mm:ss");
      String rtn = cacheCount + " - " + simpleDateFormat.format(System.currentTimeMillis());
      cacheCount++;
      return rtn;
    }
    catch(Exception e){
      return "error";
    }
  }, 5, 100, true, false);
}


// out
Catcher Test
thread-2 - get cache : null
thread-1 - get cache : null
thread-0 - get cache : null
thread-2 - get cache : null
thread-1 - get cache : null
cache created / id : thread-2 / delay :  3000
thread-0 - get cache : 0 - 16:23:235
thread-2 - get cache : 0 - 16:23:235
thread-1 - get cache : 0 - 16:23:235
thread-0 - get cache : 0 - 16:23:235
thread-2 - get cache : 0 - 16:23:235
thread-1 - get cache : 0 - 16:23:235
thread-0 - get cache : 0 - 16:23:235
thread-2 - get cache : 0 - 16:23:235
thread-1 - get cache : 0 - 16:23:235
thread-0 - get cache : 0 - 16:23:235
cache created / id : thread-0 / delay :  3000
thread-2 - get cache : 1 - 16:24:251
thread-1 - get cache : 1 - 16:24:251
thread-0 - get cache : 1 - 16:24:251
thread-2 - get cache : 1 - 16:24:251
thread-1 - get cache : 1 - 16:24:251
thread-0 - get cache : 1 - 16:24:251
thread-1 - get cache : 1 - 16:24:251
thread-2 - get cache : 1 - 16:24:251
thread-0 - get cache : 1 - 16:24:251
thread-2 - get cache : 1 - 16:24:251
thread-1 - get cache : 1 - 16:24:251
thread-0 - get cache : 1 - 16:24:251
cache created / id : thread-1 / delay :  3000
thread-1 - get cache : 2 - 16:24:183
thread-2 - get cache : 2 - 16:24:183
thread-0 - get cache : 2 - 16:24:183
thread-1 - get cache : 2 - 16:24:183
thread-2 - get cache : 2 - 16:24:183
...

```

*[ㅇㅀㅇㅀ]*

https://music.bugs.co.kr




비동기 적용

장점

단점


#### Javascript

```javascript
const express = require('express')
const app = express()
 
app.get('/', function (req, res) {
  res.send('Hello World')
})
 
app.listen(3000)
```
